import { useData } from "../../utils/data-loader";
import { functionWords, isFullUpperCase, normalizeKey } from "../../utils/str";
import { defineRule } from "./rule-base";

export const CorrectPublicationTitle = defineRule({
  id: "correct-publication-title",
  scope: "field",

  targetItemTypes: ["journalArticle"],
  targetItemField: "publicationTitle",
  async apply({ item }) {
    const publicationTitle = item.getField("publicationTitle", false, true) as string;
    let newPublicationTitle = "";
    const publicationTitleDisambiguation = await getPublicationTitleDisambiguation(publicationTitle);
    if (publicationTitleDisambiguation) {
      newPublicationTitle = publicationTitleDisambiguation;
    }
    else {
      newPublicationTitle = capitalizePublicationTitle(publicationTitle, isFullUpperCase(publicationTitle));
    }
    item.setField("publicationTitle", newPublicationTitle);
  },
});

const skipWordsForPublicationTitle = [
  "AAPG",
  "AAPPS",
  "AAPS",
  "AATCC",
  "ABB",
  "ACA",
  "ACH",
  "ACI",
  "ACM",
  "ACS",
  "AEU",
  "AGSO",
  "AGU",
  "AI",
  "EDAM",
  "AIAA",
  "AICCM",
  "AIMS",
  "AIP",
  "AJOB",
  "AKCE",
  "ANZIAM",
  "APCBEE",
  "APL",
  "APPEA",
  "AQEIC",
  "AQUA",
  "ASAIO",
  "ASCE",
  "OPEN",
  "ASHRAE",
  "ASME",
  "ASN",
  "NEURO",
  "ASSAY",
  "ASTM",
  "ASTRA",
  "AVS",
  "AWWA",
  "DDR",
  "PDE",
  "GIS",
  "ICRP",
  "DLG",
  "PNA",
  "XNA",
  "BBA",
  "BHM",
  "BIT",
  "BMC",
  "BME",
  "BMJ",
  "BMR",
  "BSGF",
  "BT",
  "NMR",
  "AAS",
  "CAAI",
  "CABI",
  "CCF",
  "CCS",
  "CEAS",
  "CES",
  "CEUR",
  "CIM",
  "CIRED",
  "CIRP",
  "CLEAN",
  "CMES",
  "CNL",
  "CNS",
  "COSPAR",
  "CPP",
  "CPSS",
  "CRISPR",
  "CSEE",
  "EEG",
  "DARU",
  "DFI",
  "DIGITAL",
  "HEALTH",
  "DNA",
  "ECS",
  "EES",
  "EFSA",
  "EJNMMI",
  "EMBO",
  "EMS",
  "EPE",
  "EPJ",
  "EPPO",
  "ESA",
  "ESAIM",
  "ESMO",
  "ETRI",
  "EURASIP",
  "EURO",
  "SP",
  "FASEB",
  "FEBS",
  "FEMS",
  "ICT",
  "OA",
  "GAMS",
  "GCB",
  "GEM",
  "GIT",
  "GM",
  "GPS",
  "IGF",
  "HAYATI",
  "HKIE",
  "HRC",
  "HTM",
  "CHP",
  "IAEA",
  "IAHS",
  "IATSS",
  "IAWA",
  "IB",
  "IBM",
  "IBRO",
  "ICES",
  "ICI",
  "ICIS",
  "IDA",
  "IEE",
  "IEEE",
  "RF",
  "RFIC",
  "RFID",
  "IEEJ",
  "IEICE",
  "IERI",
  "IES",
  "IET",
  "IETE",
  "IFAC",
  "IIE",
  "IISE",
  "IJU",
  "IMA",
  "IMPACT",
  "IOP",
  "IPPTA",
  "IRE",
  "ISA",
  "ISCB",
  "ISH",
  "ISIJ",
  "ISME",
  "ISPRS",
  "ISSS",
  "IST",
  "IT",
  "ITE",
  "IUBMB",
  "DATA",
  "COMADEM",
  "PIXE",
  "STEM",
  "JACS",
  "JAMA",
  "JASA",
  "JAWRA",
  "JBI",
  "JBIC",
  "JBMR",
  "JCEM",
  "JCIS",
  "JCO",
  "JDR",
  "JETP",
  "JFE",
  "JMIR",
  "JMM",
  "JMST",
  "JOM",
  "JOT",
  "JPC",
  "TLC",
  "JSME",
  "II",
  "III",
  "IV",
  "AOAC",
  "MMIJ",
  "MEMS",
  "MOEMS",
  "THEOCHEM",
  "TCAD",
  "VLSI",
  "ICRU",
  "UK",
  "KI",
  "KN",
  "KSCE",
  "KSII",
  "LC",
  "GC",
  "LHB",
  "LWT",
  "IGPL",
  "MBM",
  "MPT",
  "MRS",
  "JIM",
  "NACTA",
  "NAR",
  "NATO",
  "ASI",
  "NCSLI",
  "NDT",
  "NEC",
  "NEJM",
  "NFS",
  "NIR",
  "NJAS",
  "NPG",
  "NRIAG",
  "NTM",
  "LIFE",
  "RNA",
  "OENO",
  "OPEC",
  "OR",
  "OSA",
  "PCI",
  "PDA",
  "PGA",
  "PLOS",
  "PMC",
  "PMSE",
  "PPAR",
  "PRX",
  "IUTAM",
  "SPIE",
  "VLDB",
  "QRB",
  "QSAR",
  "RAD",
  "RAIRO",
  "RAP",
  "RAPRA",
  "RAS",
  "REACH",
  "RIAI",
  "RIC",
  "ROBOMECH",
  "RPS",
  "RSC",
  "AG",
  "SAE",
  "NVH",
  "SAIEE",
  "SAMPE",
  "SAR",
  "SEG",
  "SIAM",
  "SICE",
  "SICS",
  "SID",
  "SLAS",
  "SLEEP",
  "SMPTE",
  "SN",
  "SPE",
  "STAR",
  "SUT",
  "SMNS",
  "CT",
  "MRI",
  "RRL",
  "IAOS",
  "NOW",
  "TRAC",
  "TWMS",
  "MBAA",
  "FAMENA",
  "ASABE",
  "AIME",
  "IMF",
  "SAEST",
  "UCL",
  "URSI",
  "WAIMM",
  "WIT",
  "SA",
  "ZDM",
  "ZKG",
];

// 期刊名应词首大写
function capitalizePublicationTitle(publicationTitle: string, force = false) {
  return publicationTitle.split(" ").map((word, index) => {
    const upperCaseVariant = word.toUpperCase();
    const lowerCaseVariant = word.toLowerCase();
    const capitalizeVariant = word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();

    // 对于全大写的词，除非启用 force，否则不予处理
    if (word === upperCaseVariant && !force) {
      return word;
    }

    if (functionWords.includes(lowerCaseVariant)) {
      if (index === 0)
        return capitalizeVariant;
      return lowerCaseVariant;
    }
    if (skipWordsForPublicationTitle.includes(word)) {
      return word;
    }
    return capitalizeVariant;
  }).join(" ");
}

// 期刊全称消岐
async function getPublicationTitleDisambiguation(publicationTitle: string) {
  const data = await useData("journalAbbr");
  const normalizedInputKey = normalizeKey(publicationTitle);

  for (const originalKey of Object.keys(data)) {
    const normalizedOriginalKey = normalizeKey(originalKey);

    if (normalizedInputKey === normalizedOriginalKey) {
      return originalKey;
    }
  }
  return false;
}
