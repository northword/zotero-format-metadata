name: issue bot
on:
  issues:
    types:
      - labeled
      # - opened
      # - edited
      # - closed
      # - reopened
  issue_comment:
    types:
      - created
      # - edited
  schedule:
    - cron: "30 1 * * *"
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write
  discussions: write

jobs:
  feedback:
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment'
    steps:
      - name: Add "await-user-feedback" label
        if: ${{ contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association) }}
        uses: actions-cool/issues-helper@v3
        with:
          actions: add-labels
          issue-number: ${{ github.event.issue.number }}
          labels: await-user-feedback
      - name: Remove "await-user-feedback" label
        if: ${{ !contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association) }}
        uses: actions-cool/issues-helper@v3
        with:
          actions: remove-labels
          issue-number: ${{ github.event.issue.number }}
          labels: await-user-feedback

  invalid:
    name: Close invalid issue
    if: github.event.label.name == 'invalid'
    runs-on: ubuntu-latest
    steps:
      - uses: actions-cool/issues-helper@v3
        with:
          actions: close-issue, create-comment
          body: |
            Hello @${{ github.event.issue.user.login }}. This issue is marked as `invalid` and closed. Please make sure you are reporting an issue and following the issue template.

  duplicate:
    name: Close duplicate issue
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    steps:
      - uses: actions-cool/issues-helper@v3
        with:
          actions: mark-duplicate
          labels: duplicate
          close-issue: true

  stale:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      actions: write
      contents: write # only for delete-branch option
      issues: write
      pull-requests: write
    steps:
      - name: Close staled issue
        uses: actions/stale@v10
        with:
          only-labels: await-user-feedback
          days-before-issue-stale: 30
          days-before-issue-close: 7
          stale-issue-label: stale
          stale-issue-message: This issue is stale because it has been open for 30 days with no activity.
          close-issue-message: This issue was closed because it has been inactive for 7 days since being marked as stale.
          days-before-pr-stale: -1
          days-before-pr-close: -1
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Lock closed issue
        uses: dessant/lock-threads@v5
        with:
          issue-inactive-days: 30
          pr-inactive-days: 30
          exclude-any-issue-labels: keep-open
          exclude-any-pr-labels: keep-open
